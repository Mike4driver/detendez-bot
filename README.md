# DetendezBot 🤖

A multi-feature Discord bot: leveling, starboard, music, birthdays (with a permanent post), AI-powered content, D&D tools, geographic polls, quotes, scheduling, TTS, and more — built with Python and discord.py.

## ✨ Features

### 📊 Leveling System
- **XP Tracking**: Configurable XP per message and cooldown
- **Leaderboards**: Server rankings
- **Level-up Notifications**
- **Admin Controls**: Adjust levels/XP and configuration

### ⭐ Starboard
- **Highlight Great Messages**: Auto-feature by star reactions
- **Live Updates**: Star counts update with reactions
- **Smart Rules**: Prevent self-starring, handle deletions
- **Configurable**: Emoji, threshold, channel

### 🎵 Music
- **YouTube**: Play by URL or search
- **Queue Controls**: Add/remove/view, skip, stop, pause/resume, volume
- **Auto-Manage**: Auto-advance, inactivity disconnect
- **Cookie Support**: Better reliability via cookies

### 🎂 Birthday System
- **User Birthdays**: Flexible formats to set birthdays
- **Daily Announcements**: Celebrate in a set channel
- **Optional Role**: Assign a birthday role on the day
- **Permanent Birthday Post**: One pinned message listing all birthdays, updated automatically

### 🧭 Geographic Polls
- **Reaction Polls**: Users select a US region via reactions
- **Single Selection**: Auto-clears previous choices
- **Results**: View counts and percentages

### 🧠 AI-Powered Content
- **Daily Facts & Questions**: Generated by Gemini (with fallbacks)
- **Repetition Avoidance**: Tracks recent content
- **Interactive AI Chat**: Ask anything with `/ask`

### 🧙 D&D Tools
- **/roll**: Standard dice notation (e.g., 2d6+3)
- **/dnd-action**: Give an action like “level 3 smite” or “chromatic orb level 4”; bot parses with Gemini and rolls
- **/dnd-help**: Get concise 5e rules guidance

### 🗓️ Smart Scheduling
- **/schedule**: Natural-language event creation (Discord Scheduled Events)
- **Calendar Links**: Google Calendar link + ICS attachment

### 🎨 Quotes
- **/quote** and **/quote-text**: Generate styled quote images with fun decorations

### 🎤 Text-to-Speech
- **ElevenLabs**: High quality AI voices
- **Controls**: Speed, clarity, default voice

### ⚙️ Configuration
- **Per-Server Settings**: All major features configurable
- **SQLite Persistence**: Durable data with safe migrations

## 🚀 Quick Start

### Prerequisites
- Python 3.8+
- Discord Bot Token
- (Optional) Google Gemini API Key
- (Optional) ElevenLabs API Key
- (Optional) YouTube cookies file

### Installation

1) Clone and enter the repo
```bash
git clone <repository-url>
cd detendezbot
```

2) Install dependencies
```bash
pip install -r requirements.txt
```

3) Configure environment
Create a `.env` file in the project root:
```env
DISCORD_TOKEN=your_discord_bot_token_here
GEMINI_API_KEY=your_gemini_api_key_here
ELEVENLABS_API_KEY=your_elevenlabs_api_key_here
LOG_LEVEL=INFO
```

4) Run the bot
```bash
python main.py
```

### Discord Bot Setup
1) Create an application/bot in the Discord Developer Portal and copy the token

2) Generate an invite with scopes `bot` and `applications.commands`, permissions:
- Send Messages, Read Message History, Add Reactions, Use Slash Commands
- Connect, Speak (music)
- Manage Roles (birthday role)
- Embed Links, Attach Files

3) Invite the bot to your server

### Optional: Gemini AI Setup
- Get an API key from Google AI Studio and set `GEMINI_API_KEY`
- Without it: facts/questions fall back; AI-only commands (e.g., `/ask`, parts of D&D) are limited

### Optional: ElevenLabs TTS Setup
- Get an API key from ElevenLabs and set `ELEVENLABS_API_KEY`

## 📖 Usage Guide

### User Commands
- `/help` — Show help
- `/rank [user]`, `/leaderboard [limit]`
- Music: `/play`, `/queue`, `/skip`, `/stop`, `/pause`, `/resume`, `/volume`, `/nowplaying`, `/remove`
- AI Content: `/fact`, `/question`, `/ask <question>`
- TTS: `/tts <text>`, `/voices`
- Birthdays: `/setbirthday <date>`, `/birthday [user]`, `/birthdays [month]`, `/removebirthday`, `/allbirthdays`
- Starboard: `/star <message_id>`
- Geographic: `/geographic-poll`, `/geographic-results <message_id>`, `/my-region`
- D&D: `/roll <XdY[+/-Z]>`, `/dnd-action <action>`, `/dnd-help <question>`
- Scheduling: `/schedule <prompt> [timezone]`
- Quotes: `/quote <text> <@author>`, `/quote-text <text> <author_name>`

### Admin Commands (Administrator)
- Leveling: `/leveling-config`, `/setlevel`, `/addxp`, `/removexp`, `/resetxp`
- Starboard: `/starboard`, `/starboard-config`
- Birthdays: `/birthday-config` (supports `channel`, `role`, and `permanent_channel`), `/refresh-birthday-post`
- Facts & Questions: `/fact-config`, `/question-config`
- TTS: `/tts-config`
- Music cookies: `/set_cookies`, `/refresh_cookies`, `/cookie_status`

### Configuration Examples
- Leveling:
```bash
/leveling-config xp_per_message:20 cooldown:30 level_up_channel:#level-ups
```
- Starboard:
```bash
/starboard-config channel:#starboard threshold:5 emoji:⭐
```
- Birthdays (with permanent post):
```bash
/birthday-config channel:#birthdays role:@Birthday time:00:00 permanent_channel:#birthday-list
```
- Facts & Questions:
```bash
/fact-config channel:#daily-facts time:09:00
/question-config channel:#daily-questions time:15:00
```
- TTS:
```bash
/tts-config max_length:1000 default_voice:Rachel
```

## 🛠️ Development

### Project Structure
```
detendezbot/
├── main.py            # Bot entry point
├── config.py          # Configuration management
├── database.py        # Database operations (with safe migrations)
├── requirements.txt   # Python dependencies
├── cogs/              # Feature modules
│   ├── leveling.py    # XP and leveling
│   ├── starboard.py   # Starboard
│   ├── music.py       # Music
│   ├── birthday.py    # Birthdays (incl. permanent post)
│   ├── facts.py       # Daily facts
│   ├── questions.py   # Daily questions
│   ├── ai.py          # Interactive AI chat
│   ├── tts.py         # Text-to-speech
│   ├── geographic.py  # Geographic reaction polls
│   ├── quotes.py      # Quote image generator
│   └── dnd.py         # D&D tools (dice, action parser, help)
└── README.md
```

### Database Schema
SQLite tables include:
- `user_levels`, `starboard_messages`, `user_birthdays`, `guild_config`
- `recent_content`, `music_queue`, `geographic_polls`, `geographic_selections`

### Adding New Features
1) Create a new cog in `cogs/`
2) Follow existing patterns for DB access and error handling
3) Add the cog to the load list in `main.py`
4) Update this README and the help system if needed

## 🔧 Configuration Options

### Environment Variables
- `DISCORD_TOKEN` — Discord bot token (required)
- `GEMINI_API_KEY` — Google Gemini API key (optional)
- `ELEVENLABS_API_KEY` — ElevenLabs API key (optional)
- `LOG_LEVEL` — INFO, DEBUG, WARNING, ERROR

### Per-Server Settings
Configurable via slash commands for leveling, starboard, birthdays (incl. permanent post), facts, questions, TTS, and more.

## 🐛 Troubleshooting

1) Bot not responding — verify permissions, token, and command sync (restart)
2) Music issues — check voice perms, yt-dlp, and cookies
3) AI not working — set `GEMINI_API_KEY`, check quota
4) TTS not working — set `ELEVENLABS_API_KEY`, check limits
5) Database errors — ensure write permissions; restarting runs migrations

### Logging
Logs to console and `bot.log`. Review logs for details.

## 📝 License
Open source. Modify and distribute as needed.

## 🤝 Contributing
PRs and issues welcome for bugs and features.

## 📞 Support
Open an issue for support or questions.

---
Note: Your DM has final say on D&D rulings. Use responsibly within Discord’s terms.